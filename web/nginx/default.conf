server {
  listen 80;
  server_name _;

  # Docker embedded DNS resolver
  resolver 127.0.0.11 valid=10s ipv6=off;

  root /usr/share/nginx/html;
  index index.html;

  # Demo UX: avoid confusing stale frontend assets in browser cache.
  location ~* \.(?:html|js|css)$ {
    add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
    expires off;
    try_files $uri =404;
  }

  location / {
    try_files $uri $uri/ /index.html;
  }

  # Reverse proxy to API container; frontend calls /api/...
  location /api/ {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;

    # Routing may take a while on cold start (OSM graph download/build).
    proxy_connect_timeout 10s;
    proxy_send_timeout 600s;
    proxy_read_timeout 600s;
    send_timeout 600s;

    proxy_buffering off;
    proxy_request_buffering off;

    # Force runtime DNS resolution (avoids stale container IP -> 502)
    set $upstream "http://api:8000";

    rewrite ^/api/(.*)$ /$1 break;
    proxy_pass $upstream;
  }
}
