services:
  localstack:
    image: localstack/localstack:3
    ports:
      - "4566:4566"
    environment:
      - SERVICES=s3,sqs,dynamodb
      - AWS_DEFAULT_REGION=eu-west-1
      # Names used by localstack init script (safe defaults)
      - S3_GRAPHS_BUCKET=urbanpath-graphs
      - S3_STREET_BUCKET=urbanpath-street-graphs
      - SQS_QUEUE_NAME=urbanpath-route-requests
      - DDB_TABLE_NAME=urbanpath-route-results
    healthcheck:
      test: ["CMD-SHELL", "health_json=$(curl -sS --max-time 2 http://localhost:4566/_localstack/health) && echo \"$$health_json\" | grep -qE '\"s3\"[[:space:]]*:[[:space:]]*\"(running|available)\"' && echo \"$$health_json\" | grep -qE '\"sqs\"[[:space:]]*:[[:space:]]*\"(running|available)\"' && echo \"$$health_json\" | grep -qE '\"dynamodb\"[[:space:]]*:[[:space:]]*\"(running|available)\"'"]
      interval: 2s
      timeout: 3s
      retries: 60
    volumes:
      - localstack-data:/var/lib/localstack
      - ./localstack/init:/etc/localstack/init

  localstack-init:
    profiles: ["demo"]
    image: amazon/aws-cli:2
    environment:
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=eu-west-1
      - AWS_REGION=eu-west-1
      - ENDPOINT_URL=http://localstack:4566
      - S3_GRAPHS_BUCKET=urbanpath-graphs
      - S3_STREET_BUCKET=urbanpath-street-graphs
      - SQS_QUEUE_NAME=urbanpath-route-requests
      - DDB_TABLE_NAME=urbanpath-route-results
    depends_on:
      localstack:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-lc"]
    command:
      - |
        set -eu
        echo "[localstack-init] waiting for health..."
        for i in $(seq 1 60); do
          if curl -sS --max-time 2 "${ENDPOINT_URL}/_localstack/health" | grep -q '"s3"'; then
            break
          fi
          sleep 1
        done

        echo "[localstack-init] ensuring buckets..."
        aws --endpoint-url="${ENDPOINT_URL}" s3api head-bucket --bucket "${S3_GRAPHS_BUCKET}" >/dev/null 2>&1 || \
          aws --endpoint-url="${ENDPOINT_URL}" s3api create-bucket --bucket "${S3_GRAPHS_BUCKET}" --region "${AWS_DEFAULT_REGION}" --create-bucket-configuration LocationConstraint="${AWS_DEFAULT_REGION}" >/dev/null 2>&1 || true
        aws --endpoint-url="${ENDPOINT_URL}" s3api head-bucket --bucket "${S3_STREET_BUCKET}" >/dev/null 2>&1 || \
          aws --endpoint-url="${ENDPOINT_URL}" s3api create-bucket --bucket "${S3_STREET_BUCKET}" --region "${AWS_DEFAULT_REGION}" --create-bucket-configuration LocationConstraint="${AWS_DEFAULT_REGION}" >/dev/null 2>&1 || true

        echo "[localstack-init] ensuring sqs queue..."
        aws --endpoint-url="${ENDPOINT_URL}" sqs get-queue-url --queue-name "${SQS_QUEUE_NAME}" --region "${AWS_DEFAULT_REGION}" >/dev/null 2>&1 || \
          aws --endpoint-url="${ENDPOINT_URL}" sqs create-queue --queue-name "${SQS_QUEUE_NAME}" --region "${AWS_DEFAULT_REGION}" >/dev/null

        echo "[localstack-init] ensuring dynamodb table..."
        aws --endpoint-url="${ENDPOINT_URL}" dynamodb describe-table --table-name "${DDB_TABLE_NAME}" --region "${AWS_DEFAULT_REGION}" >/dev/null 2>&1 || \
          aws --endpoint-url="${ENDPOINT_URL}" dynamodb create-table \
            --table-name "${DDB_TABLE_NAME}" \
            --billing-mode PAY_PER_REQUEST \
            --attribute-definitions AttributeName=request_id,AttributeType=S \
            --key-schema AttributeName=request_id,KeyType=HASH \
            --region "${AWS_DEFAULT_REGION}" >/dev/null

        echo "[localstack-init] done."
    restart: "no"

  api:
    profiles: ["demo"]
    build: .
    environment:
      - ENDPOINT_URL=http://localstack:4566
      - AWS_REGION=eu-west-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - SQS_QUEUE_URL=http://localstack:4566/000000000000/urbanpath-route-requests
      - DDB_TABLE=urbanpath-route-results
      - STREET_GRAPH_BUCKET=urbanpath-street-graphs
      - OSMNX_CACHE_FOLDER=/app/osm_cache
      - OSM_GRAPH_PATH=/app/osm_prebuilt/lpa_walk.graphml
      - OSM_GRAPH_AUTO_BUILD=1
      - OSM_PLACE=Las Palmas de Gran Canaria, Canary Islands, Spain
    depends_on:
      localstack:
        condition: service_healthy
      localstack-init:
        condition: service_completed_successfully
    ports:
      - "8000:8000"
    volumes:
      - osm-cache:/app/osm_cache
      - osm-prebuilt:/app/osm_prebuilt

  worker:
    profiles: ["demo"]
    build: .
    command: ["python", "-m", "src.worker"]
    environment:
      - ENDPOINT_URL=http://localstack:4566
      - AWS_REGION=eu-west-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - SQS_QUEUE_URL=http://localstack:4566/000000000000/urbanpath-route-requests
      - DDB_TABLE=urbanpath-route-results
      - STREET_GRAPH_BUCKET=urbanpath-street-graphs
      - WORKER_LOOP=1
      - OSMNX_CACHE_FOLDER=/app/osm_cache
      - OSM_GRAPH_PATH=/app/osm_prebuilt/lpa_walk.graphml
      - OSM_GRAPH_AUTO_BUILD=1
      - OSM_PLACE=Las Palmas de Gran Canaria, Canary Islands, Spain
    depends_on:
      localstack:
        condition: service_healthy
      localstack-init:
        condition: service_completed_successfully
    volumes:
      - osm-cache:/app/osm_cache
      - osm-prebuilt:/app/osm_prebuilt

  web:
    profiles: ["demo"]
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./web:/usr/share/nginx/html:ro
      - ./web/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - api

volumes:
  localstack-data:
  osm-cache:
  osm-prebuilt:
